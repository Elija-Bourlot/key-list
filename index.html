<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deister Key List</title>
  <style>
    :root{
      --bg:#0b0c10;
      --text:#eef0f4;
      --muted:#a7adbb;
      --line:#2a2f44;
      --chip:#0f1320;
      --header:#0e1220;
      --accent:#7aa2ff;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* Sticky title bar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: rgba(14,18,32,.92);
      border-bottom: 1px solid rgba(42,47,68,.8);
    }
    .topbar-inner{
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px 14px;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .subtitle{
      margin:0;
      color: var(--muted);
      font-size: 12px;
      line-height:1.3;
    }
    .top-meta{
      display:flex;
      justify-content: space-between;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px 14px 40px;
    }
    .panel{
      background: rgba(18,21,33,.9);
      border: 1px solid rgba(42,47,68,.9);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    /* Controls: mobile-first = stacked */
    .controls{
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    input[type="search"]{
      flex: 1 1 260px;
      min-width: 220px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(42,47,68,.9);
      background: #0f1320;
      color: var(--text);
      outline:none;
    }
    input[type="search"]::placeholder{ color:#7f8698; }

    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(42,47,68,.9);
      background: #0f1320;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ border-color:#3a4260; }
    .btn:active{ transform: translateY(1px); }
    .btn-sm{
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
    }

    .filtersTitle{
      color: var(--muted);
      font-size: 12px;
      margin: 2px 0 6px;
    }
    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:8px 10px;
    }
    .chip{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(42,47,68,.9);
      background: var(--chip);
      font-size: 12px;
    }
    .chip input{ accent-color: var(--accent); }

    /* Actions below filters */
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    /* Table scroll container (vertical only) */
    .tableWrap{
      margin-top: 12px;
      border: 1px solid rgba(42,47,68,.9);
      border-radius: 14px;
      background: rgba(18,21,33,.8);

      overflow-y: auto;
      overflow-x: hidden;           /* no horizontal scroll */
      -webkit-overflow-scrolling: touch;

      max-height: 60vh;             /* JS will improve sizing */
    }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 13px;
      table-layout: fixed;          /* forces columns to fit */
    }

    thead th{
      position: sticky;
      top: 0;                       /* fixed at top of tableWrap */
      z-index: 20;
      background: rgba(17,21,34,.98);
      border-bottom: 1px solid rgba(42,47,68,.9);
      text-align:left;
      padding: 10px 10px;
      font-weight: 750;
      user-select:none;
      white-space: nowrap;
      cursor:pointer;
    }
    thead th small{ color: var(--muted); font-weight: 700; margin-left: 6px; }

    tbody td{
      border-top: 1px solid rgba(42,47,68,.55);
      padding: 10px 10px;
      vertical-align: top;
      overflow-wrap: anywhere;      /* wrap long text */
      word-break: break-word;
    }
    tbody tr:hover{ background: rgba(122,162,255,.06); }

    /* Column sizing */
    .col-key{ width: 6ch; }         /* room for 3 digits + padding */
    .col-user{ width: 10ch; }       /* compact user column */
    .col-loc{ width: auto; }

    /* Center User column (header + cells) */
    th.user, td.user{ text-align:center; }

    /* Key column: compact, centred */
    th.key, td.key{ text-align:center; }

    .tag{
      display:inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(42,47,68,.9);
      background:#0f1320;
      font-size: 12px;
      white-space: nowrap;
    }
    .empty{ color:#7f8698; font-style: italic; }

    @media (min-width: 860px){
      .topbar-inner{
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      h1{ font-size: 18px; }
      .subtitle{ max-width: 560px; text-align:right; }

      .controls{
        display:grid;
        grid-template-columns: 1.2fr .8fr;
        gap: 12px;
        align-items: start;
      }
      .actions{
        justify-content: flex-start;
      }
    }

    /* Modal */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      z-index:100;
      background:rgba(0,0,0,.55);
      padding: 14px;
    }
    .modal-card{
      max-width: 680px;
      margin: 10vh auto;
      border-radius: 14px;
      border: 1px solid rgba(42,47,68,.9);
      background: rgba(18,21,33,.98);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      padding: 12px 14px;
      background: rgba(14,18,32,.95);
      border-bottom: 1px solid rgba(42,47,68,.9);
    }
    .modal-title{
      font-weight: 800;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .modal-body{ padding: 14px; }
    .form{
      display:grid;
      gap: 10px;
    }
    .field-label{
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .input, .select{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(42,47,68,.9);
      background:#0f1320;
      color:var(--text);
      outline:none;
    }
    .form-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top: 6px;
    }
    .note{
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.35;
    }
    .warn{
      color: #ffcc80;
      font-size: 12px;
      display:none;
      line-height:1.35;
    }
  </style>
</head>
<body>
  <div class="topbar" id="topbar">
    <div class="topbar-inner">
      <div>
        <h1>Deister Key List</h1>
        <p class="subtitle">Search across key, location and user. Use filters to narrow results.</p>
      </div>
      <div class="top-meta">
        <div>Results: <strong id="count">0</strong> / <span id="total">0</span></div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel" id="panel">
      <div class="controls" id="controls">
        <div>
          <div class="row">
            <input id="q" type="search" placeholder="Search… e.g. 40 George, Hope Park, Master, 2nd Floor" autocomplete="off" />
            <button class="btn" id="clearBtn" title="Clear search and filters">Clear</button>
          </div>
        </div>

        <div>
          <div class="filtersTitle">Filter by user:</div>
          <div class="filters" id="filters"></div>

          <!-- Buttons moved below filters -->
          <div class="actions">
            <button class="btn" id="addBtn" title="Add a new key">Add key</button>
            <button class="btn" id="editBtn" title="Edit an existing key by number">Edit key</button>
          </div>
        </div>
      </div>

      <div class="tableWrap" id="tableWrap" role="region" aria-label="Key list table" tabindex="0">
        <table>
          <thead>
            <tr>
              <th class="key col-key" data-col="key">Key <small id="sortKey"></small></th>
              <th class="col-loc" data-col="location">Location <small id="sortLoc"></small></th>
              <th class="user col-user" data-col="user">User <small id="sortUser"></small></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal (used for Add and Edit) -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Add key</div>
        <button class="btn btn-sm" id="closeModalBtn" aria-label="Close">Close</button>
      </div>
      <div class="modal-body">
        <form class="form" id="form">
          <!-- For Edit flow: user enters the key to edit -->
          <div id="editPickBlock" style="display:none;">
            <label>
              <div class="field-label">Key to edit (1–999)</div>
              <input class="input" id="pickKey" type="number" min="1" max="999" inputmode="numeric" />
            </label>
            <div class="warn" id="pickWarn">Key not found. Please enter an existing key number.</div>
          </div>

          <label>
            <div class="field-label">Key (1–999)</div>
            <input class="input" id="fKey" type="number" min="1" max="999" required inputmode="numeric" />
          </label>

          <label>
            <div class="field-label">Location</div>
            <input class="input" id="fLocation" type="text" required />
          </label>

          <label>
            <div class="field-label">User</div>
            <select class="select" id="fUser" required>
              <option value="Servitors">Servitors</option>
              <option value="Cleaners">Cleaners</option>
              <option value="Security">Security</option>
              <option value="Accomm.">Accomm.</option>
            </select>
          </label>

          <div class="form-actions">
            <button class="btn btn-sm" type="button" id="cancelBtn">Cancel</button>
            <button class="btn btn-sm" type="submit" id="saveBtn">Save</button>
          </div>

          <div class="note">
            Changes are saved to this browser (localStorage). Works on GitHub Pages with no backend.
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
  // ---------------- DATA ----------------
  const rows = [
    {key:1, location:"Appleton tower", user:"Security"},
    {key:2, location:"40 GS/Café", user:"Security"},
    {key:3, location:"50 GS / 55 - 60 GS", user:"Security"},
    {key:4, location:"New Business School", user:"Security"},
    {key:5, location:"50 George Square 3rd Floor Sub", user:"Cleaners"},
    {key:6, location:"Ladies Basement 40 George Square", user:"Cleaners"},
    {key:7, location:"40 George Square Basement", user:"Cleaners"},
    {key:8, location:"40 George Square – Ground Floor", user:"Cleaners"},
    {key:9, location:"40 George Square – Lecture Halls", user:"Cleaners"},
    {key:10, location:"40 George Square – Floor 1", user:"Cleaners"},
    {key:11, location:"40 George Square – Floor 2", user:"Cleaners"},
    {key:12, location:"40 George Square – Floor 3", user:"Cleaners"},
    {key:13, location:"40 George Square – Floor 4", user:"Cleaners"},
    {key:14, location:"40 George Square – Floor 5 -DHT", user:"Cleaners"},
    {key:15, location:"40 George Square – Floor 6", user:"Cleaners"},
    {key:16, location:"40 George Square – Floor 7", user:"Cleaners"},
    {key:17, location:"40 George Square – Floor 8", user:"Cleaners"},
    {key:18, location:"40 George Square – Floor 9", user:"Cleaners"},
    {key:19, location:"40 George Square – Floor 10", user:"Cleaners"},
    {key:20, location:"40 George Square – Floor 11", user:"Cleaners"},
    {key:21, location:"40 George Square – Floor 12", user:"Cleaners"},
    {key:22, location:"40 George Square – Floor 13", user:"Cleaners"},
    {key:23, location:"Appleton Tower", user:"Servitors"},
    {key:24, location:"7 George Sq – Basement", user:"Cleaners"},
    {key:25, location:"7 George Sq – Ground Floor", user:"Cleaners"},
    {key:26, location:"7 George Sq – 1st Floor", user:"Cleaners"},
    {key:27, location:"7 George Sq – 2nd Floor", user:"Cleaners"},
    {key:28, location:"55 George square", user:"Cleaners"},
    {key:29, location:"56 George square", user:"Cleaners"},
    {key:30, location:"57 George square", user:"Cleaners"},
    {key:31, location:"58 George square", user:"Cleaners"},
    {key:32, location:"59 - 60 George square", user:"Cleaners"},
    {key:33, location:"50 George Square - ground", user:"Cleaners"},
    {key:34, location:"50 George Square – 1st floor (2 keys)", user:"Cleaners"},
    {key:35, location:"50 George Square – 1st floor (1 key)", user:"Cleaners"},
    {key:36, location:"50 George Square – 2nd floor (2keys)", user:"Cleaners"},
    {key:37, location:"50 George Square – 2nd floor (1key)", user:"Cleaners"},
    {key:38, location:"50 George Square – 3rd floor (2 keys)", user:"Cleaners"},
    {key:39, location:"50 George Square – 4th floor (2keys)", user:"Cleaners"},
    {key:40, location:"50 George Square – 4th floor (1key)", user:"Cleaners"},
    {key:41, location:"Business School", user:"Servitors"},
    {key:42, location:"50 George square - Ground Floor", user:"Cleaners"},
    {key:43, location:"7 George square – Ground Floor", user:"Cleaners"},
    {key:44, location:"George Square Gardens", user:"Security"},
    {key:45, location:"3 Hope Park square", user:"Security"},
    {key:46, location:"19 George square", user:"Security"},
    {key:47, location:"Plant and Comms room", user:"Security"},
    {key:48, location:"IMGS Masters – 16 - 20 George square", user:"Servitors"},
    {key:49, location:"50GS - Front and Rear Door", user:"Servitors"},
    {key:50, location:"50GS - Ground Floor Master", user:"Servitors"},
    {key:51, location:"50GS – 1st Floor Master", user:"Servitors"},
    {key:52, location:"50GS – 2nd Floor Master", user:"Servitors"},
    {key:53, location:"50GS – 3rd Floor Master", user:"Servitors"},
    {key:54, location:"50GS 4th Floor Master", user:"Servitors"},
    {key:55, location:"50GS – Lower Ground Master", user:"Servitors"},
    {key:56, location:"50GS – Servitors Room", user:"Servitors"},
    {key:57, location:"50GS – All Masters 1", user:"Servitors"},
    {key:58, location:"50GS – All Masters 2", user:"Servitors"},
    {key:59, location:"50GS – Cleaners Master", user:"Servitors"},
    {key:60, location:"50 George Square", user:"Servitors"},
    {key:61, location:"50 George Square", user:"Servitors"},
    {key:62, location:"50 George Square", user:"Servitors"},
    {key:63, location:"50 George Square", user:"Servitors"},
    {key:64, location:"50 George Square", user:"Servitors"},
    {key:65, location:"40 George Square", user:"Servitors"},
    {key:66, location:"NA", user:"NA"},
    {key:67, location:"CMB", user:"Servitors"},
    {key:68, location:"21 Buccleuch Place 2.06", user:"Security"},
    {key:69, location:"Buccleuch Place 2,5,7,8,12", user:"Accommodation"},
    {key:70, location:"12,97 Buccleuch Street / 8 Hope Park Square", user:"Accommodation"},
    {key:71, location:"West Nicolson Street 7,11,13,15,19", user:"Accommodation"},
    {key:72, location:"92,96 Nicolson St / 3 Davie St / 1,11 West Richmond St", user:"Accommodation"},
    {key:73, location:"", user:""},
    {key:74, location:"1 George Square", user:"Servitors"},
    {key:75, location:"40 George Square - Switch Cupboard LGZ29", user:"Security"},
    {key:76, location:"40 George Square Halls", user:"Servitors"},
    {key:77, location:"Gordon Aikman Lecture Theatre", user:"Servitors"},
    {key:78, location:"", user:""},
    {key:79, location:"", user:""},
    {key:80, location:"30 - 34 Buccleuch", user:"Servitors"},
    {key:81, location:"Buccleuch Classrooms", user:"Servitors"},
    {key:82, location:"", user:""},
    {key:83, location:"12 - 25 Buccleuch Place", user:"Servitors"},
    {key:84, location:"7 George Square", user:"Servitors"},
    {key:85, location:"55 - 60 George Square", user:"Servitors"},
    {key:86, location:"18 - 27 George Square", user:"Servitors"},
    {key:87, location:"", user:""},
    {key:88, location:"22B Buccleuch Place", user:"Cleaners"},
    {key:89, location:"", user:""},
    {key:90, location:"34 Buccleuch Place", user:"Cleaners"},
    {key:91, location:"Business School Lower Ground", user:"Cleaners"},
    {key:92, location:"Business School – Ground Floor", user:"Cleaners"},
    {key:93, location:"Business School Level 1", user:"Cleaners"},
    {key:94, location:"Business School Level 2", user:"Cleaners"},
    {key:95, location:"Business School Level 3", user:"Cleaners"},
    {key:96, location:"Business School Level 4", user:"Cleaners"},
    {key:97, location:"17 Buccleuch Place", user:"Cleaners"},
    {key:98, location:"18 Buccleuch Place", user:"Cleaners"},
    {key:99, location:"19 Buccleuch Place", user:"Cleaners"},
    {key:100, location:"21 Buccleuch Place", user:"Cleaners"},
    {key:101, location:"22 Buccleuch Place", user:"Cleaners"},
    {key:102, location:"22A Buccleuch Place", user:"Cleaners"},
    {key:103, location:"34 Buccleuch Place - 3rd Floor", user:"Cleaners"},
    {key:104, location:"24 Buccleuch Place - 1st Floor", user:"Cleaners"},
    {key:105, location:"24 Buccleuch Place – 2nd Floor", user:"Cleaners"},
    {key:106, location:"24 Buccleuch Place – 3rd Floor", user:"Cleaners"},
    {key:107, location:"24 Buccleuch Place – Attic", user:"Cleaners"},
    {key:108, location:"25 Buccleuch Place", user:"Cleaners"},
    {key:109, location:"30 Buccleuch Place", user:"Cleaners"},
    {key:110, location:"31 Buccleuch Place", user:"Cleaners"},
    {key:111, location:"31 Buccleuch Place – 2nd Floor", user:"Cleaners"},
    {key:112, location:"31 Buccleuch Place – 3rd Floor", user:"Cleaners"},
    {key:113, location:"31 Buccleuch Place – 4th Floor", user:"Cleaners"},
    {key:114, location:"33 Buccleuch Place", user:"Cleaners"},
    {key:115, location:"34 Buccleuch Place – 1st Floor", user:"Cleaners"},
    {key:116, location:"34 Buccleuch Place - 2nd Floor", user:"Cleaners"},
    {key:117, location:"23 Buccleuch Place", user:"Cleaners"},
    {key:118, location:"34 Buccleuch Place – 4th Floor", user:"Cleaners"},
    {key:119, location:"2 Hope Park Square", user:"Cleaners"},
    {key:120, location:"8 Hope Park Square", user:"Cleaners"},
    {key:121, location:"9 Hope Park Square", user:"Cleaners"},
    {key:122, location:"Quartermile (Returned to project team)", user:""},
    {key:123, location:"RHSC (20 Sylvan Place)", user:"Cleaners"},
    {key:124, location:"McKenzie Medical", user:"Cleaners"},
    {key:125, location:"12 Buccleuch Street", user:"Cleaners"},
    {key:126, location:"", user:""},
    {key:127, location:"", user:""},
    {key:128, location:"", user:""}
  ];

  // ---------------- NORMALISATION ----------------
  function normUser(u){
    const s = String(u ?? "").trim();
    if (!s) return "";
    const low = s.toLowerCase();
    if (low === "security") return "Security";
    if (low === "cleaners") return "Cleaners";
    if (low === "servitors") return "Servitors";
    if (low === "accommodation") return "Accomm.";
    if (low === "accomm." || low === "accomm") return "Accomm.";
    if (low === "na") return "NA";
    return s;
  }
  rows.forEach(r => r.user = normUser(r.user));

  // ---------------- ELEMENTS ----------------
  const q = document.getElementById('q');
  const tbody = document.getElementById('tbody');
  const countEl = document.getElementById('count');
  const totalEl = document.getElementById('total');
  const filtersEl = document.getElementById('filters');
  const clearBtn = document.getElementById('clearBtn');
  const addBtn = document.getElementById('addBtn');
  const editBtn = document.getElementById('editBtn');
  const tableWrap = document.getElementById('tableWrap');

  // Modal elements
  const modal = document.getElementById("modal");
  const modalTitle = document.getElementById("modalTitle");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const form = document.getElementById("form");

  const editPickBlock = document.getElementById("editPickBlock");
  const pickKey = document.getElementById("pickKey");
  const pickWarn = document.getElementById("pickWarn");

  const fKey = document.getElementById("fKey");
  const fLocation = document.getElementById("fLocation");
  const fUser = document.getElementById("fUser");

  totalEl.textContent = rows.length;

  // Allowed users (filters exclude NA and blank user)
  const allowedUsersOrder = ["Servitors","Cleaners","Security","Accomm."];
  const users = Array.from(new Set(rows.map(r => r.user)))
    .filter(u => u && u !== "NA" && allowedUsersOrder.includes(u))
    .sort((a,b)=> allowedUsersOrder.indexOf(a) - allowedUsersOrder.indexOf(b));

  // Default: all allowed users selected
  const selectedUsers = new Set(users);

  // Sorting state
  let sortCol = "key";
  let sortDir = "asc"; // asc | desc

  // ---------------- LOCAL STORAGE ----------------
  const STORAGE_KEY = "deister_key_list_v2";

  function loadRows(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }
  function saveRows(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
  }

  const saved = loadRows();
  if (saved && Array.isArray(saved) && saved.length){
    rows.length = 0;
    saved.forEach(x => rows.push(x));
    rows.forEach(r => r.user = normUser(r.user));
  }

  // ---------------- FILTERS ----------------
  function renderFilters(){
    filtersEl.innerHTML = "";
    users.forEach(u => {
      const label = document.createElement('label');
      label.className = "chip";

      const cb = document.createElement('input');
      cb.type = "checkbox";
      cb.checked = selectedUsers.has(u);

      cb.addEventListener('change', () => {
        if (cb.checked) selectedUsers.add(u);
        else selectedUsers.delete(u);
        render();
      });

      const span = document.createElement('span');
      span.textContent = u;

      label.appendChild(cb);
      label.appendChild(span);
      filtersEl.appendChild(label);
    });
  }

  // ---------------- FILTER + SEARCH ----------------
  function shouldDisplayRow(r){
    if (!r.user || r.user === "NA") return false;
    if (!allowedUsersOrder.includes(r.user)) return false;
    return true;
  }

  function applyFilters(){
    const term = q.value.trim().toLowerCase();

    return rows.filter(r => {
      if (!shouldDisplayRow(r)) return false;

      if (selectedUsers.size && !selectedUsers.has(r.user)) return false;

      if (!term) return true;
      const hay = `${r.key}\t${r.location || ""}\t${r.user}`.toLowerCase();
      return hay.includes(term);
    });
  }

  // ---------------- SORT ----------------
  function sortData(data){
    const dir = sortDir === "asc" ? 1 : -1;
    const getVal = (r) => {
      if (sortCol === "key") return Number(r.key);
      if (sortCol === "location") return (r.location || "").toLowerCase();
      if (sortCol === "user") return (r.user || "").toLowerCase();
      return "";
    };
    return data.slice().sort((a,b)=>{
      const va = getVal(a), vb = getVal(b);
      if (typeof va === "number" && typeof vb === "number") return (va - vb) * dir;
      return String(va).localeCompare(String(vb)) * dir;
    });
  }

  // ---------------- RENDER TABLE ----------------
  function render(){
    let data = applyFilters();
    data = sortData(data);

    countEl.textContent = data.length;
    tbody.innerHTML = "";

    for (const r of data){
      const tr = document.createElement('tr');

      const tdKey = document.createElement('td');
      tdKey.className = "key";
      tdKey.textContent = r.key;

      const tdLoc = document.createElement('td');
      tdLoc.textContent = r.location || "";
      if (!r.location) tdLoc.innerHTML = '<span class="empty">—</span>';

      const tdUser = document.createElement('td');
      tdUser.className = "user";
      tdUser.innerHTML = `<span class="tag">${escapeHtml(r.user)}</span>`;

      tr.appendChild(tdKey);
      tr.appendChild(tdLoc);
      tr.appendChild(tdUser);
      tbody.appendChild(tr);
    }

    document.getElementById("sortKey").textContent = sortCol==="key" ? (sortDir==="asc" ? "▲" : "▼") : "";
    document.getElementById("sortLoc").textContent = sortCol==="location" ? (sortDir==="asc" ? "▲" : "▼") : "";
    document.getElementById("sortUser").textContent = sortCol==="user" ? (sortDir==="asc" ? "▲" : "▼") : "";

    syncTableMaxHeight();
  }

  // ---------------- EVENTS ----------------
  q.addEventListener('input', render);

  clearBtn.addEventListener('click', () => {
    q.value = "";
    selectedUsers.clear();
    users.forEach(u => selectedUsers.add(u));
    renderFilters();
    render();
  });

  // Sorting by clicking headers
  document.querySelectorAll('thead th').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.col;
      if (!col) return;
      if (sortCol === col) sortDir = (sortDir === "asc") ? "desc" : "asc";
      else { sortCol = col; sortDir = "asc"; }
      render();
    });
  });

  // ---------------- MODAL FLOW (ADD / EDIT) ----------------
  let mode = "add";          // "add" | "edit"
  let editingIndex = -1;     // row index in rows[] for edit, after key is found
  let originalSnapshot = null;

  function openModal(){
    modal.style.display = "block";
    modal.setAttribute("aria-hidden", "false");
  }
  function closeModal(){
    modal.style.display = "none";
    modal.setAttribute("aria-hidden", "true");
    mode = "add";
    editingIndex = -1;
    originalSnapshot = null;
    pickWarn.style.display = "none";
    pickKey.value = "";
  }

  closeModalBtn.addEventListener("click", closeModal);
  cancelBtn.addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if (e.target === modal) closeModal(); });

  function nextKeyNumber(){
    const max = rows.reduce((m,r)=> Math.max(m, Number(r.key)||0), 0);
    return Math.min(999, max + 1);
  }

  function openAdd(){
    mode = "add";
    modalTitle.textContent = "Add key";
    editPickBlock.style.display = "none";
    pickWarn.style.display = "none";

    fKey.disabled = false;
    fKey.value = nextKeyNumber();
    fLocation.value = "";
    fUser.value = "Servitors";

    openModal();
    fLocation.focus();
  }

  function openEdit(){
    mode = "edit";
    modalTitle.textContent = "Edit key";
    editPickBlock.style.display = "block";
    pickWarn.style.display = "none";

    // In edit mode, user first chooses the key to edit
    fKey.disabled = true;
    fKey.value = "";
    fLocation.value = "";
    fUser.value = "Servitors";

    originalSnapshot = null;
    editingIndex = -1;

    openModal();
    pickKey.focus();
  }

  addBtn.addEventListener("click", openAdd);
  editBtn.addEventListener("click", openEdit);

  // When user enters a key to edit, auto-load the record
  pickKey.addEventListener("input", () => {
    const k = Number(pickKey.value);
    if (!k) {
      pickWarn.style.display = "none";
      editingIndex = -1;
      fKey.value = "";
      fLocation.value = "";
      return;
    }

    const idx = rows.findIndex(r => Number(r.key) === k);
    if (idx < 0) {
      pickWarn.style.display = "block";
      editingIndex = -1;
      fKey.value = "";
      fLocation.value = "";
      return;
    }

    pickWarn.style.display = "none";
    editingIndex = idx;

    // Load values
    const r = rows[idx];
    fKey.value = r.key;
    fLocation.value = r.location || "";
    fUser.value = normUser(r.user) || "Servitors";

    // Snapshot for cancel (not strictly needed, but helpful)
    originalSnapshot = { key: r.key, location: r.location || "", user: normUser(r.user) };
  });

  // Save (Add/Edit)
  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const keyNum = Number(fKey.value);
    const location = String(fLocation.value ?? "").trim();
    const user = normUser(fUser.value);

    if (!keyNum || keyNum < 1 || keyNum > 999) return;
    if (!location) return;
    if (!user || user === "NA" || !allowedUsersOrder.includes(user)) return;

    if (mode === "add") {
      // ensure unique key
      const exists = rows.some(r => Number(r.key) === keyNum);
      if (exists) { alert("That key already exists."); return; }

      rows.push({ key: keyNum, location, user });
      rows.sort((a,b)=> Number(a.key) - Number(b.key));
      saveRows();
      closeModal();
      render();
      return;
    }

    // edit mode
    if (editingIndex < 0) {
      alert("Enter an existing key number to edit.");
      return;
    }

    // Update only location/user (key stays the same in edit mode)
    rows[editingIndex].location = location;
    rows[editingIndex].user = user;

    saveRows();
    closeModal();
    render();
  });

  // ---------------- UTILS ----------------
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    })[c]);
  }

  // Make table area fit the screen
  function syncTableMaxHeight(){
    const rect = tableWrap.getBoundingClientRect();
    const pad = 14;
    const available = window.innerHeight - rect.top - pad;
    const minH = 260;
    tableWrap.style.maxHeight = Math.max(minH, Math.floor(available)) + "px";
  }
  window.addEventListener("resize", syncTableMaxHeight);

  // ---------------- INIT ----------------
  renderFilters();
  render();
  syncTableMaxHeight();
</script>
</body>
</html>
